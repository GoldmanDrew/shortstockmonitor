name: Daily ETF Pipeline

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch: {}

env:
  PYTHONUNBUFFERED: '1'
  GITHUB_WORKSPACE: ${{ github.workspace }}
  CAGR_CSV: ${{ github.workspace }}/config/etf_cagr.csv
  OUTPUT_DIR: ${{ github.workspace }}/data
  OUTPUT_FILE: ${{ github.workspace }}/data/etf_screened_today.csv
  SCREENED_CSV: ${{ github.workspace }}/data/etf_screened_today.csv
  SNAPSHOT_DIR: data/shortstock_snapshots
  IBKR_FTP_FILE: usa.txt

jobs:
  run-daily-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run ETF screener
        env:
          BORROW_CAP: ${{ secrets.BORROW_CAP || '0.12' }}
        run: |
          python etf_screener.py

      - name: Run short stock monitor
        env:
          SCREENED_CSV: ${{ env.SCREENED_CSV }}
          SNAPSHOT_DIR: ${{ env.SNAPSHOT_DIR }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM || 'werdnamdlog01@gmail.com' }}
          EMAIL_TO: ${{ secrets.EMAIL_TO || 'dag5wd@virginia.edu' }}
          SMTP_HOST: ${{ secrets.SMTP_HOST || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SMTP_USER: ${{ secrets.SMTP_USER || '' }}
          SMTP_PASS: ${{ secrets.SMTP_PASS || '' }}
        run: |
          python short_stock_monitor.py
